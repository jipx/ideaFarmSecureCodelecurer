{"version":"tree-0.1","tree":{"id":"App","path":"","constructInfo":{"fqn":"aws-cdk-lib.App","version":"2.200.1"},"children":{"SecureWafStack":{"id":"SecureWafStack","path":"SecureWafStack","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"2.200.1"},"children":{"EmergencyToggle":{"id":"EmergencyToggle","path":"SecureWafStack/EmergencyToggle","constructInfo":{"fqn":"aws-cdk-lib.aws_ssm.StringParameter","version":"2.200.1","metadata":[]},"children":{"Resource":{"id":"Resource","path":"SecureWafStack/EmergencyToggle/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ssm.CfnParameter","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SSM::Parameter","aws:cdk:cloudformation:props":{"name":"/waf/emergency-block","type":"String","value":"false"}}}}},"AdminIPSet":{"id":"AdminIPSet","path":"SecureWafStack/AdminIPSet","constructInfo":{"fqn":"aws-cdk-lib.aws_wafv2.CfnIPSet","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::WAFv2::IPSet","aws:cdk:cloudformation:props":{"addresses":["203.0.113.5/32"],"ipAddressVersion":"IPV4","name":"AllowAdminIP","scope":"REGIONAL"}}},"SecureWebACL":{"id":"SecureWebACL","path":"SecureWafStack/SecureWebACL","constructInfo":{"fqn":"aws-cdk-lib.aws_wafv2.CfnWebACL","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::WAFv2::WebACL","aws:cdk:cloudformation:props":{"defaultAction":{"block":{}},"name":"SecureWebACL","rules":[{"name":"AllowAdminIP","priority":0,"statement":{"ipSetReferenceStatement":{"arn":{"Fn::GetAtt":["AdminIPSet","Arn"]}}},"visibilityConfig":{"cloudWatchMetricsEnabled":true,"metricName":"AllowAdmin","sampledRequestsEnabled":true},"action":{"allow":{}}},{"name":"RateLimit","priority":1,"statement":{"rateBasedStatement":{"aggregateKeyType":"IP","limit":100}},"visibilityConfig":{"cloudWatchMetricsEnabled":true,"metricName":"RateLimit","sampledRequestsEnabled":true},"action":{"block":{}}},{"name":"RegionCheck","priority":2,"statement":{"byteMatchStatement":{"fieldToMatch":{"singleHeader":{"Name":"X-Client-Region"}},"positionalConstraint":"EXACTLY","textTransformations":[{"priority":0,"type":"LOWERCASE"}],"searchString":"SG"}},"visibilityConfig":{"cloudWatchMetricsEnabled":true,"metricName":"RegionCheck","sampledRequestsEnabled":true},"action":{"block":{}}}],"scope":"REGIONAL","visibilityConfig":{"cloudWatchMetricsEnabled":true,"metricName":"SecureWebACL","sampledRequestsEnabled":true}}}},"Assoc0":{"id":"Assoc0","path":"SecureWafStack/Assoc0","constructInfo":{"fqn":"aws-cdk-lib.aws_wafv2.CfnWebACLAssociation","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::WAFv2::WebACLAssociation","aws:cdk:cloudformation:props":{"resourceArn":"arn:aws:apigateway:ap-northeast-1::/restapis/h2xytc3k1c/stages/prod","webAclArn":{"Fn::GetAtt":["SecureWebACL","Arn"]}}}},"Assoc1":{"id":"Assoc1","path":"SecureWafStack/Assoc1","constructInfo":{"fqn":"aws-cdk-lib.aws_wafv2.CfnWebACLAssociation","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::WAFv2::WebACLAssociation","aws:cdk:cloudformation:props":{"resourceArn":"arn:aws:apigateway:ap-northeast-1::/restapis/zwt8qi6x33/stages/prod","webAclArn":{"Fn::GetAtt":["SecureWebACL","Arn"]}}}},"Assoc2":{"id":"Assoc2","path":"SecureWafStack/Assoc2","constructInfo":{"fqn":"aws-cdk-lib.aws_wafv2.CfnWebACLAssociation","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::WAFv2::WebACLAssociation","aws:cdk:cloudformation:props":{"resourceArn":"arn:aws:apigateway:ap-northeast-1::/restapis/x6r8nro53c/stages/prod","webAclArn":{"Fn::GetAtt":["SecureWebACL","Arn"]}}}},"Assoc3":{"id":"Assoc3","path":"SecureWafStack/Assoc3","constructInfo":{"fqn":"aws-cdk-lib.aws_wafv2.CfnWebACLAssociation","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::WAFv2::WebACLAssociation","aws:cdk:cloudformation:props":{"resourceArn":"arn:aws:apigateway:ap-northeast-1::/restapis/brusxlpum5/stages/prod","webAclArn":{"Fn::GetAtt":["SecureWebACL","Arn"]}}}},"Assoc4":{"id":"Assoc4","path":"SecureWafStack/Assoc4","constructInfo":{"fqn":"aws-cdk-lib.aws_wafv2.CfnWebACLAssociation","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::WAFv2::WebACLAssociation","aws:cdk:cloudformation:props":{"resourceArn":"arn:aws:apigateway:ap-northeast-1::/restapis/u8w3qqosk4/stages/prod","webAclArn":{"Fn::GetAtt":["SecureWebACL","Arn"]}}}},"Assoc5":{"id":"Assoc5","path":"SecureWafStack/Assoc5","constructInfo":{"fqn":"aws-cdk-lib.aws_wafv2.CfnWebACLAssociation","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::WAFv2::WebACLAssociation","aws:cdk:cloudformation:props":{"resourceArn":"arn:aws:apigateway:ap-northeast-1::/restapis/orr7xjr63m/stages/dev","webAclArn":{"Fn::GetAtt":["SecureWebACL","Arn"]}}}},"UpdateWafLambda":{"id":"UpdateWafLambda","path":"SecureWafStack/UpdateWafLambda","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.Function","version":"2.200.1","metadata":[]},"children":{"ServiceRole":{"id":"ServiceRole","path":"SecureWafStack/UpdateWafLambda/ServiceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.200.1","metadata":[]},"children":{"ImportServiceRole":{"id":"ImportServiceRole","path":"SecureWafStack/UpdateWafLambda/ServiceRole/ImportServiceRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.200.1","metadata":[]}},"Resource":{"id":"Resource","path":"SecureWafStack/UpdateWafLambda/ServiceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"SecureWafStack/UpdateWafLambda/ServiceRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.200.1","metadata":[]},"children":{"Resource":{"id":"Resource","path":"SecureWafStack/UpdateWafLambda/ServiceRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["wafv2:GetWebACL","wafv2:UpdateWebACL","ssm:GetParameter"],"Effect":"Allow","Resource":"*"}],"Version":"2012-10-17"},"policyName":"UpdateWafLambdaServiceRoleDefaultPolicy6D00B770","roles":[{"Ref":"UpdateWafLambdaServiceRole780FC6ED"}]}}}}}}},"Resource":{"id":"Resource","path":"SecureWafStack/UpdateWafLambda/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnFunction","version":"2.200.1"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"zipFile":"\nimport boto3\n\nssm = boto3.client(\"ssm\")\nwaf = boto3.client(\"wafv2\")\n\ndef handler(event, context):\n    toggle = ssm.get_parameter(Name=\"/waf/emergency-block\")['Parameter']['Value']\n    acl = waf.get_web_acl(Name='SecureWebACL', Scope='REGIONAL')\n    token = acl['LockToken']\n    id = acl['WebACL']['Id']\n    config = acl['WebACL']\n\n    waf.update_web_acl(\n        Name='SecureWebACL',\n        Scope='REGIONAL',\n        Id=id,\n        LockToken=token,\n        DefaultAction={\"Block\": {}} if toggle == 'true' else config['DefaultAction'],\n        VisibilityConfig=config['VisibilityConfig'],\n        Rules=[] if toggle == 'true' else config['Rules']\n    )\n    return {\"mode\": toggle}\n"},"handler":"index.handler","role":{"Fn::GetAtt":["UpdateWafLambdaServiceRole780FC6ED","Arn"]},"runtime":"python3.11","timeout":30}}}}},"CDKMetadata":{"id":"CDKMetadata","path":"SecureWafStack/CDKMetadata","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"Default":{"id":"Default","path":"SecureWafStack/CDKMetadata/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.200.1"}},"Condition":{"id":"Condition","path":"SecureWafStack/CDKMetadata/Condition","constructInfo":{"fqn":"aws-cdk-lib.CfnCondition","version":"2.200.1"}}}},"BootstrapVersion":{"id":"BootstrapVersion","path":"SecureWafStack/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.200.1"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"SecureWafStack/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"2.200.1"}}}},"Tree":{"id":"Tree","path":"Tree","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}}}}